<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>WebGl Ray-Tracing</title>
        <link rel="stylesheet" href="./css/stylesheet.css">
            <script type="text/javascript" src="./js/gl-matrix-min.js"></script>
            <script type="text/javascript" src="./js/webgl-debug.js"></script>
            <script type="text/javascript" src="./js/webgl-utils.js"></script>
            <script type="text/javascript" src="./js/rayTracing.js"></script>
            <!-- vertex shader -->
            <script id="shader-vs" type="x-shader/x-vertex">
                attribute vec3 aVertexPosition;
                uniform mat4 uMVMatrix;
                uniform mat4 uPMatrix;
                void main(void) {
                    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                }
            </script>
                <!-- fragment shader -->
            <script id="shader-fs" type="x-shader/x-fragment">
                precision mediump float;
                vec3 uDir;
                vec3 uOri = vec3(0.0,0.0,2.5);

                float uSphereRayon = 0.25;
                vec3 uSpherePos = vec3(0.0,0.0,0.0);

                vec3 normalForSphere(vec3 hit, vec3 sphereCenter, float sphereRadius) {
                    return (hit - sphereCenter) / sphereRadius;
                }

                float intersectSphere(vec3 origin, vec3 ray, vec3 sphereCenter, float sphereRadius) {
                    vec3 toSphere = origin - sphereCenter;
                    float a = dot(ray, ray);
                    float b = 2.0 * dot(toSphere, ray);
                    float c = dot(toSphere, toSphere) - sphereRadius*sphereRadius;
                    float discriminant = b*b - 4.0*a*c;
                    if(discriminant > 0.0) {
                        float t = (-b - sqrt(discriminant)) / (2.0 * a);
                        if(t > 0.0){
                            return t;
                        }
                    }
                    return 10000.0;
                }

                vec3 raytrace(vec3 dir, vec3 origin){
                    vec3 light = vec3(0.0,2.0,2.0);
                    vec3 accumulatedColor = vec3(0.0,0.0,0.0);
                    float tsphere = intersectSphere(origin,dir,uSpherePos,uSphereRayon);
                    float t = 10000.0;
                    if(tsphere < t){
                        t = tsphere;
                    }
                    vec3 hit = origin + dir * t;
                    vec3 surfaceColor = vec3(0.75);
                    vec3 normal;

                    if (t == tsphere){
                        normal = normalForSphere(hit, uSpherePos, uSphereRayon);
                    }

                    vec3 toLight = light - hit;
                    float diffuse = max(0.0, dot(normalize(toLight), normal));
                    accumulatedColor += surfaceColor * (0.5 * diffuse);
                    return accumulatedColor;
                }

                void main(void) {

                    float x = ((2.0 * ((gl_FragCoord.x + 0.5) * (1.0/512.0)) - 1.0) * 0.70);
                    float y = ((1.0 - 2.0 * ((gl_FragCoord.y + 0.5) * (1.0/512.0))) * 0.70);
                    uDir = vec3(x,y,-1.0);
                    vec3 dir = normalize(uDir);
                    vec3 color = raytrace(dir,uOri);
                    gl_FragColor = vec4(color,1.0);
                }
            </script>
    </head>
    <body>
      <h1>WebGl Ray-Tracing</h1>
      <p>
        Canvas pour cr√©er une application WebGL.
      </p>
      <div id="main">
        <canvas id="glcanvas" width="512" height="512"></canvas>
        <div id="error"><noscript>Please enable JavaScript.</noscript></div>
        <h2>Interaction</h2>
          <p>
            <button type="button" name="button" onclick="">Click Me!</button>
          </p>
      </div>
  </body>
</html>
